#!/bin/bash
set -e

# --- Secret scanning ---
echo "Scanning for secrets..."
SECRET_PATTERNS=(
    'sk-[a-zA-Z0-9]{20,}'
    'pk_live_[a-zA-Z0-9]{20,}'
    'ghp_[a-zA-Z0-9]{36}'
    'gho_[a-zA-Z0-9]{36}'
    'AKIA[0-9A-Z]{16}'
    '-{5}BEGIN RSA PRIVATE'
    '-{5}BEGIN OPENSSH PRIVATE'
    'xoxb-[0-9]{10,}'
    'xoxp-[0-9]{10,}'
    'clerk_[a-zA-Z0-9]{20,}'
)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
SCAN_EXCLUDE_PATTERN='(\.md|\.gitkeep|pre-commit)$'
for file in $STAGED_FILES; do
    if echo "$file" | grep -qE "$SCAN_EXCLUDE_PATTERN"; then
        continue
    fi
    for pattern in "${SECRET_PATTERNS[@]}"; do
        if git show ":$file" 2>/dev/null | grep -qE -- "$pattern"; then
            echo "POTENTIAL SECRET in $file matching: $pattern"
            exit 1
        fi
    done
done

# --- File size check (1MB limit) ---
echo "Checking file sizes..."
MAX_SIZE_KB=1024
for file in $STAGED_FILES; do
    SIZE=$(git cat-file -s ":$file" 2>/dev/null || echo 0)
    if [ "$SIZE" -gt $((MAX_SIZE_KB * 1024)) ]; then
        echo "ERROR: $file exceeds ${MAX_SIZE_KB}KB ($(( SIZE / 1024 ))KB)"
        exit 1
    fi
done

# --- Detect which stacks changed ---
TS_CHANGED=$(echo "$STAGED_FILES" | grep -cE '\.(ts|tsx|js|jsx|mjs)$' || true)

# --- TypeScript checks (only if TS files changed) ---
if [ "$TS_CHANGED" -gt 0 ]; then
    echo "Running TypeScript type check..."
    for tsconfig in apps/*/tsconfig.json packages/*/tsconfig.json; do
        if [ -f "$tsconfig" ]; then
            npx tsc --noEmit -p "$tsconfig" 2>&1
            if [ $? -ne 0 ]; then
                echo "Type check failed for $tsconfig. Fix errors before committing."
                exit 1
            fi
        fi
    done

    echo "Running ESLint..."
    npx eslint --max-warnings 0 . 2>&1
    if [ $? -ne 0 ]; then
        echo "ESLint failed. Fix errors before committing."
        exit 1
    fi
fi

echo "All checks passed."
